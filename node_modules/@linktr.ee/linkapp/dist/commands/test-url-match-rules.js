import pc from 'picocolors';
import { existsSync, readFileSync } from 'node:fs';
import { join } from 'node:path';
import { getAppConfig } from '../lib/auth/config.js';
import { getToken } from '../lib/auth/token-storage.js';
import { testUrlMatchRules } from '../lib/deploy/test-url-match-rules.js';
const writeLine = (message = '') => {
    process.stdout.write(`${message}\n`);
};
export async function testUrlMatchRulesCommand(url, options) {
    writeLine(pc.cyan(`üß™ Testing URL match rules for: ${url}`));
    writeLine();
    try {
        const config = await getAppConfig(options.qa ? 'qa' : 'production');
        const projectPath = process.cwd();
        // Check authentication
        const accessToken = getToken(config.auth.audience);
        if (!accessToken) {
            writeLine(pc.red('‚úó Not authenticated'));
            writeLine(pc.dim(`  Run: npx @linktr.ee/linkapp login${options.qa ? ' --qa' : ''}`));
            writeLine();
            process.exit(1);
        }
        // Look up the local url_match_rules.json file
        const urlMatchRulesPath = join(projectPath, 'url_match_rules.json');
        if (!existsSync(urlMatchRulesPath)) {
            writeLine(pc.red('‚úó url_match_rules.json not found in current directory'));
            writeLine();
            process.exit(1);
        }
        writeLine(pc.cyan('üìã Loading URL match rules from url_match_rules.json...'));
        const urlMatchRulesString = readFileSync(urlMatchRulesPath, 'utf8');
        if (!urlMatchRulesString) {
            writeLine(pc.red('‚úó url_match_rules.json is empty'));
            writeLine();
            process.exit(1);
        }
        let urlMatchRules = null;
        try {
            urlMatchRules = JSON.parse(urlMatchRulesString);
            writeLine(pc.green('‚úì URL match rules loaded successfully'));
            writeLine();
        }
        catch (error) {
            writeLine(pc.red('‚úó url_match_rules.json is invalid JSON'));
            writeLine();
            process.exit(1);
        }
        // Test URL against match rules
        writeLine(pc.cyan('üîç Testing URL against match rules...'));
        writeLine();
        const apiUrl = options.endpoint ?? `${config.link_types_url}/link-types`;
        const result = await testUrlMatchRules(apiUrl, url, urlMatchRules, accessToken);
        const success = result.success;
        writeLine(`${success ? pc.green('üéâ Success') : pc.red('‚ùå Failed')}`);
        writeLine();
        writeLine(pc.bold('Test Result:'));
        writeLine(JSON.stringify(result, null, 2));
        writeLine();
    }
    catch (error) {
        console.error(pc.red('\n‚úó Test failed:'), error);
        process.exit(1);
    }
}
//# sourceMappingURL=test-url-match-rules.js.map