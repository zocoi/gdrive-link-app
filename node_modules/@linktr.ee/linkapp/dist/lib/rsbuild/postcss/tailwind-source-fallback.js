import { dirname, relative } from 'node:path';
function toPosixPath(value) {
    return value.replace(/\\/g, '/');
}
const DEFAULT_GLOB = '**/*.{ts,tsx,js,jsx,mdx,html}';
export function createTailwindSourceFallback(options) {
    const { projectRoot, glob = DEFAULT_GLOB } = options;
    const plugin = () => {
        const postcssPlugin = {
            postcssPlugin: 'linkapp:tailwind-source-fallback',
            Once(root, { result }) {
                const sourceFile = typeof result.opts.from === 'string' ? result.opts.from : null;
                if (!sourceFile) {
                    return;
                }
                // Only mutate files that live inside the user's project
                const normalizedSourceFile = toPosixPath(sourceFile);
                const normalizedProjectRoot = toPosixPath(projectRoot.endsWith('/') ? projectRoot : `${projectRoot}/`);
                if (!normalizedSourceFile.startsWith(normalizedProjectRoot)) {
                    return;
                }
                let hasSourceDirective = false;
                root.walkAtRules('source', () => {
                    hasSourceDirective = true;
                    return false;
                });
                if (hasSourceDirective) {
                    return;
                }
                const cssDir = dirname(sourceFile);
                const relativeToRoot = relative(cssDir, projectRoot);
                const baseSegment = relativeToRoot === '' ? '.' : relativeToRoot;
                const normalizedBase = toPosixPath(baseSegment);
                const trimmedBase = normalizedBase.replace(/\/$/, '');
                const sourcePath = trimmedBase === '.' || trimmedBase === ''
                    ? `./${glob}`
                    : `${trimmedBase}/${glob}`;
                // Insert after the last @import to preserve ordering
                let lastImport;
                root.walkAtRules('import', (node) => {
                    lastImport = node;
                });
                // Use root.append with string to avoid postcss version mismatch
                // between user's postcss and Rsbuild's compiled postcss
                if (lastImport) {
                    lastImport.after(`@source "${sourcePath}"`);
                }
                else {
                    root.prepend(`@source "${sourcePath}"`);
                }
            },
            postcss: true,
        };
        return postcssPlugin;
    };
    plugin.postcss = true;
    plugin.__linkappTailwindSource = true;
    return plugin;
}
//# sourceMappingURL=tailwind-source-fallback.js.map