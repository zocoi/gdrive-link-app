import { createHash } from 'node:crypto';
import { writeFileSync, mkdirSync } from 'node:fs';
import { join, dirname } from 'node:path';
/**
 * Rsbuild plugin that creates a build manifest with versioned assets
 * This helps invalidate cache on deployment
 */
export function assetVersioning(options = {}) {
    const manifestPath = options.manifestPath || 'build-manifest.json';
    const manifest = {};
    return {
        name: 'linkapp:asset-versioning',
        setup(api) {
            api.onAfterBuild(({ stats }) => {
                if (!stats)
                    return;
                // Clear previous manifest
                Object.keys(manifest).forEach((key) => delete manifest[key]);
                const statsJson = stats.toJson({ assets: true, chunks: true });
                // Collect all asset mappings
                if (statsJson.assets) {
                    for (const asset of statsJson.assets) {
                        if (asset.name) {
                            // Store original name -> hashed name mapping
                            const originalName = asset.name.replace(/\.[a-f0-9]+\./, '.');
                            manifest[originalName] = asset.name;
                        }
                    }
                }
                // Mark entry chunks
                if (statsJson.entrypoints) {
                    for (const [_entryName, entry] of Object.entries(statsJson.entrypoints)) {
                        if (entry && typeof entry === 'object' && 'assets' in entry) {
                            const entryAssets = entry.assets;
                            for (const asset of entryAssets) {
                                manifest[`${asset.name}.entry`] = 'true';
                            }
                        }
                    }
                }
                // Add build timestamp
                manifest['_buildTime'] = new Date().toISOString();
                manifest['_buildHash'] = createHash('sha256')
                    .update(JSON.stringify(manifest))
                    .digest('hex')
                    .slice(0, 8);
                // Write manifest to disk
                const outDir = join(process.cwd(), 'dist');
                const fullPath = join(outDir, manifestPath);
                try {
                    // Ensure the output directory exists
                    mkdirSync(dirname(fullPath), { recursive: true });
                    writeFileSync(fullPath, JSON.stringify(manifest, null, 2));
                }
                catch (error) {
                    console.warn('Failed to write build manifest:', error);
                }
            });
        },
    };
}
//# sourceMappingURL=asset-versioning.js.map