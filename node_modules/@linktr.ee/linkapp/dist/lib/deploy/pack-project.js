import archiver from 'archiver';
import { createWriteStream, existsSync, statSync } from 'node:fs';
import { join } from 'node:path';
export async function packProject(options = {}) {
    const projectPath = options.projectPath || process.cwd();
    const outputPath = options.outputPath || join(projectPath, 'package.tgz');
    // Check for config file in both locations (root first, then .config for backward compatibility)
    const rootConfigPath = join(projectPath, 'linkapp.config.ts');
    const configPath = existsSync(rootConfigPath) ? 'linkapp.config.ts' : '.config/linkapp.config.ts';
    const requiredFiles = [configPath];
    const optionalFiles = ['package.json', 'package-lock.json', 'README.md', 'tsconfig.json', 'yarn.lock', 'postcss.config.mjs', 'postcss.config.js', 'postcss.config.cjs'];
    const requiredDirs = ['app'];
    const optionalDirs = ['components', 'hooks', 'lib', 'public'];
    // Manifest files from .linkapp directory
    const linkappDir = join(projectPath, '.linkapp');
    const manifestFiles = [
        { source: join(linkappDir, 'manifest.json'), dest: 'manifest.json', required: true },
        { source: join(linkappDir, 'settings.json'), dest: 'settings.json', required: false },
        { source: join(linkappDir, 'url_match_rules.json'), dest: 'url_match_rules.json', required: false },
    ];
    // Icon file from dist directory (copied during build from app/icon.svg)
    const iconSource = join(projectPath, 'dist', 'icon.svg');
    const packedFiles = [];
    // Validate required files exist
    for (const file of requiredFiles) {
        const filePath = join(projectPath, file);
        if (!existsSync(filePath)) {
            throw new Error(`Required file missing: ${file}`);
        }
    }
    // Validate required directories exist
    for (const dir of requiredDirs) {
        const dirPath = join(projectPath, dir);
        if (!existsSync(dirPath) || !statSync(dirPath).isDirectory()) {
            throw new Error(`Required directory missing: ${dir}`);
        }
    }
    // Validate required manifest files exist
    for (const manifest of manifestFiles) {
        if (manifest.required && !existsSync(manifest.source)) {
            throw new Error(`Required manifest file missing: ${manifest.dest}. Run manifest generation first.`);
        }
    }
    return new Promise((resolve, reject) => {
        const output = createWriteStream(outputPath);
        const archive = archiver('tar', {
            gzip: true,
            gzipOptions: { level: 9 },
        });
        output.on('close', () => {
            resolve(packedFiles);
        });
        archive.on('error', (err) => {
            reject(err);
        });
        archive.on('warning', (err) => {
            if (err.code === 'ENOENT') {
                console.warn('Warning:', err.message);
            }
            else {
                reject(err);
            }
        });
        archive.pipe(output);
        // Add manifest files to package root
        for (const manifest of manifestFiles) {
            if (existsSync(manifest.source)) {
                archive.file(manifest.source, { name: manifest.dest });
                packedFiles.push(manifest.dest);
            }
        }
        // Add icon.svg to package root if it exists
        if (existsSync(iconSource)) {
            archive.file(iconSource, { name: 'icon.svg' });
            packedFiles.push('icon.svg');
        }
        // Add required files
        for (const file of requiredFiles) {
            const filePath = join(projectPath, file);
            if (existsSync(filePath)) {
                archive.file(filePath, { name: file });
                packedFiles.push(file);
            }
        }
        // Add optional files
        for (const file of optionalFiles) {
            const filePath = join(projectPath, file);
            if (existsSync(filePath)) {
                archive.file(filePath, { name: file });
                packedFiles.push(file);
            }
        }
        // Add required directories
        for (const dir of requiredDirs) {
            const dirPath = join(projectPath, dir);
            if (existsSync(dirPath)) {
                archive.directory(dirPath, dir);
                packedFiles.push(`${dir}/`);
            }
        }
        // Add optional directories
        for (const dir of optionalDirs) {
            const dirPath = join(projectPath, dir);
            if (existsSync(dirPath) && statSync(dirPath).isDirectory()) {
                archive.directory(dirPath, dir);
                packedFiles.push(`${dir}/`);
            }
        }
        archive.finalize();
    });
}
//# sourceMappingURL=pack-project.js.map