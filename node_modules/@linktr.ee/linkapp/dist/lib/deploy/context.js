import { getAppConfig } from '../auth/config.js';
import { getToken } from '../auth/token-storage.js';
import { resolveConfigPath, getLinkAppIdFromConfig } from '../config/resolve-config-path.js';
import { AuthenticationError } from '../utils/errors.js';
import { writeSection } from '../utils/output.js';
/**
 * Initializes the deployment context by loading configuration,
 * authenticating, and preparing all necessary information.
 *
 * @param options - Deploy command options
 * @returns Deployment context
 * @throws AuthenticationError if not authenticated
 * @throws Error if configuration loading fails
 */
export async function initializeDeployment(options) {
    const env = options.qa ? 'qa' : 'production';
    const config = await getAppConfig(env);
    const projectPath = options.path ?? process.cwd();
    // Resolve config path and extract LinkApp ID
    const configPath = resolveConfigPath(projectPath);
    const linkAppId = await getLinkAppIdFromConfig(configPath);
    // Display deployment header
    writeSection(`Deploying ${linkAppId} to ${env}`);
    // Check authentication
    const accessToken = getToken(config.auth.audience);
    if (!accessToken) {
        throw new AuthenticationError(env);
    }
    return {
        env,
        config,
        projectPath,
        linkAppId,
        accessToken,
        startTime: Date.now(),
        options,
    };
}
//# sourceMappingURL=context.js.map