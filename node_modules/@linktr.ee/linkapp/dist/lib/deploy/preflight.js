import { existsSync } from 'node:fs';
import { join } from 'node:path';
import pc from 'picocolors';
import { buildCommand } from '../../commands/build.js';
import { validateProject, printValidationResults } from './validation.js';
import { ValidationError } from '../utils/errors.js';
import { writeLine, writeIndented } from '../utils/output.js';
import { formatElapsedTime } from '../utils/formatters.js';
/**
 * Ensures the project has been built before deployment.
 * Runs the build command if dist/ directory doesn't exist.
 *
 * @param context - Deployment context
 */
async function ensureProjectBuilt(context) {
    if (context.options.skipBuild) {
        return;
    }
    const distPath = join(context.projectPath, 'dist');
    if (existsSync(distPath)) {
        return;
    }
    writeLine(pc.bold('Building project...'));
    const buildStart = Date.now();
    await buildCommand({ sourcemap: false });
    const buildTime = formatElapsedTime(Date.now() - buildStart);
    writeIndented(`Completed in ${buildTime}`);
    writeLine();
}
/**
 * Validates the project structure and configuration.
 * Checks for required files, valid config, and proper setup.
 *
 * @param context - Deployment context
 * @throws ValidationError if validation fails
 */
async function validateProjectStructure(_context) {
    writeLine(pc.bold('Pre-deployment checks'));
    const validationResult = await validateProject();
    printValidationResults(validationResult);
    if (!validationResult.success) {
        writeLine();
        throw new ValidationError('Validation failed');
    }
    writeLine();
}
/**
 * Runs all preflight checks before deployment.
 * Includes building the project and validating its structure.
 *
 * @param context - Deployment context
 */
export async function runPreflightChecks(context) {
    await ensureProjectBuilt(context);
    if (!context.options.skipChecks) {
        await validateProjectStructure(context);
    }
}
//# sourceMappingURL=preflight.js.map