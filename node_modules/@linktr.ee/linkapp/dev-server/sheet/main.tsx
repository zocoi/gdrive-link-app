import Sheet from "@/app/sheet";
import { StrictMode } from "react";
import { createRoot } from "react-dom/client";
import "@/app/globals.css";
import { THEME_PRESETS } from "../shared/theme-presets";
import { getThemeFromUrl, mergeThemeProps } from "../shared/theme-utils";

// Declare global window properties for theme and font application
declare global {
  interface Window {
    __linkapp_applyTheme?: (variables: Record<string, string>) => void
    __linkapp_applyFont?: (fontData: {
      fontFamily: string
      fontStyle?: string
      cssUrl?: string
    }) => void
  }
}

// Preview props injected by dev server via define
declare const __PREVIEW_PROPS__: Record<string, unknown>;

// Extract just the variables from THEME_PRESETS for theme lookups
const THEME_VARS = Object.fromEntries(
  Object.entries(THEME_PRESETS).map(([key, { variables }]) => [key, variables])
);

// Get theme variables from URL
const themeVariables = getThemeFromUrl(THEME_VARS);

// Get the selected theme key from URL or default to "default"
const urlParams = new URLSearchParams(window.location.search);
const themeKey = urlParams.get("theme") || "default";
const selectedTheme = THEME_PRESETS[themeKey as keyof typeof THEME_PRESETS] || THEME_PRESETS.default;

// Merge with preview props
const previewProps = __PREVIEW_PROPS__ || {};
const mergedProps = mergeThemeProps(themeVariables, previewProps);

// Apply theme CSS variables on mount
if (themeVariables && window.__linkapp_applyTheme) {
  window.__linkapp_applyTheme(themeVariables);
}

// Apply font on mount
if (selectedTheme.font && window.__linkapp_applyFont) {
  window.__linkapp_applyFont(selectedTheme.font);
}

const rootElement = document.getElementById("root");
if (!rootElement) {
  throw new Error("Root element not found");
}

createRoot(rootElement).render(
  <StrictMode>
    <Sheet {...mergedProps} />
  </StrictMode>,
);
