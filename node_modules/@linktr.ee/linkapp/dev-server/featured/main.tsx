import Featured from "@/app/featured";
import { StrictMode } from "react";
import { createRoot } from "react-dom/client";
import "@/app/globals.css";
import { THEME_PRESETS } from "../shared/theme-presets";
import { getThemeFromUrl, mergeThemeProps } from "../shared/theme-utils";

// Try to import FeaturedCarousel if it exists
let FeaturedCarousel: React.ComponentType<any> | null = null;
try {
  FeaturedCarousel = require("@/app/featured-carousel").default;
} catch (e) {
  // featured-carousel.tsx doesn't exist, that's ok
}

// Declare global window properties for theme and font application
declare global {
  interface Window {
    __linkapp_applyTheme?: (variables: Record<string, string>) => void;
    __linkapp_applyFont?: (fontData: {
      fontFamily: string;
      fontStyle?: string;
      cssUrl?: string;
    }) => void;
  }
}

// Preview props injected by dev server via define
declare const __PREVIEW_PROPS__: Record<string, unknown>;

// Extract just the variables from THEME_PRESETS for theme lookups
const THEME_VARS = Object.fromEntries(
  Object.entries(THEME_PRESETS).map(([key, { variables }]) => [key, variables]),
);

// Get theme variables and groupLayoutOption from URL
const params = new URLSearchParams(window.location.search);
const groupLayoutOptionParam = params.get("groupLayoutOption");
const themeVariables = getThemeFromUrl(THEME_VARS);

// Get the selected theme for font application
const themeKey = params.get("theme") || "default";
const selectedTheme =
  THEME_PRESETS[themeKey as keyof typeof THEME_PRESETS] ||
  THEME_PRESETS.default;

// Merge with preview props and add groupLayoutOption
const previewProps = __PREVIEW_PROPS__ || {};
const mergedProps = mergeThemeProps(themeVariables, previewProps, {
  groupLayoutOption: groupLayoutOptionParam || undefined,
});

// Apply theme CSS variables on mount
if (themeVariables && window.__linkapp_applyTheme) {
  window.__linkapp_applyTheme(themeVariables);
}

// Apply font on mount
if (selectedTheme.font && window.__linkapp_applyFont) {
  window.__linkapp_applyFont(selectedTheme.font);
}

const rootElement = document.getElementById("root");
if (!rootElement) {
  throw new Error("Root element not found");
}

// Select the appropriate component based on groupLayoutOption parameter
const LayoutComponent =
  groupLayoutOptionParam === "carousel" && FeaturedCarousel
    ? FeaturedCarousel
    : Featured;

createRoot(rootElement).render(
  <StrictMode>
    <LayoutComponent {...mergedProps} />
  </StrictMode>,
);
